{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
{% if user.is_authenticated %}
  Hi {{ user.username }}!
  <p><a href="{% url 'logout' %}">Log Out</a></p>
  <div
    class="chat__item__container"
    id="id_chat_item_container"
    style="font-size: 20px"
  >
    <br />
    <input type="text" id="id_message_send_input" />
    <button type="submit" id="id_message_send_button">Send </button>
    <br />
    <br />
  </div>
  {{ slug|json_script:"room_slug" }}
  
  <script>
    const roomSlug = JSON.parse(document.getElementById('room_slug').textContent);
    // const apiKey = '7ee9132d-c84e-449e-9f91-50997e65f6cf';  // Replace 'your_api_key_here' with the actual API key

    // const chatSocket = new WebSocket(`ws://${window.location.host}/ws/${roomSlug}/?api_key=${apiKey}`);
    const chatSocket = new WebSocket(`ws://${window.location.host}/ws/${roomSlug}/`);


    chatSocket.onopen = function (e) {
      console.log("The connection was set up successfully!");
    };

    document.querySelector("#id_message_send_input").focus();
    document.querySelector("#id_message_send_input").onkeyup = function (e) {
      if (e.keyCode == 13) {
        document.querySelector("#id_message_send_button").click();
      }
    };

    document.querySelector("#id_message_send_button").onclick = function (e) {
      var messageInput = document.querySelector("#id_message_send_input").value;
      chatSocket.send(JSON.stringify({ message: messageInput, username: "{{request.user.username}}" }));
    };

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      var div = document.createElement("div");
      div.innerHTML = data.username + " : " + data.message;
      document.querySelector("#id_message_send_input").value = "";
      document.querySelector("#id_chat_item_container").appendChild(div);
    };
  </script>
{% else %}
  <p>You are not logged in</p>
  <a href="{% url 'login' %}">Log In</a>
{% endif %}
{% endblock %}
